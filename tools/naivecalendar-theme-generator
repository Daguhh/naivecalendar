#!/bin/bash

DATA_DIR="$(dirname $0)/../src"

ABS_DATA_DIR=$(realpath $DATA_DIR)
THEMES_PATH="$ABS_DATA_DIR/themes"
COMMON_FILES_PATH="$THEMES_PATH/common"
THEME_PATH="$HOME/.config/naivecalendar/themes"
CONFIG_NAME="config"

help_msg () {

    echo """
**usage** :  naivecalendar *theme-generator* [-h] [-a|-r] [-f]

Generate config for naivecalendar by setting shape and theme
Create config in ~/.config/naivecalendar/themes/

**optional arguments:**
  -h, --help                    show this help message and exit
  -n, --new_file                save config in a new file instead of default(=config)
  -a, --all                     generate and show one by one all themes
  -f, --folder                  output files in given folder, else in default user folder
"

}


# Save parameters
option="$@"


# Loop over named parameters
IS_NEW_FILE="false"
IS_ALL="false"

while [ $# -gt 0 ] ; do
    key="$1"
    case $key in
        -h|--help)
            help_msg 
            exit 0
            ;;
        -n|--new_file)
            IS_NEW_FILE="true"
            ;;
        -a|--all)
            IS_ALL="true"
            ;;
        -f|--folder)
            THEME_PATH="$2"
            shift
            ;;
        *)
          printf "**************************\n"
          printf " Wrong argument : $1\n"
          printf "**************************\n"
          exit 1
    esac
    shift # past value
done


gen_conf () {

    # Create rasi conf

    if ! [ -d "$THEME_PATH" ]; then
        mkdir -p "$THEME_PATH" 
    fi

    if ( "$IS_NEW_FILE" ); then
        CONFIG_NAME="$shape"_"$theme"
    fi

    USER_THEME_CONFIG="$THEME_PATH/$CONFIG_NAME"

    # Write to config file
    cat <<EOF > $USER_THEME_CONFIG.rasi
/* Generated by naivecalendar
theme : $shape - $theme

Could be erased by naivecalendar, 
please save your conf in a separate file
*/


@import "$COMMON_FILES_PATH/theme_$theme.rasi"
@import "$COMMON_FILES_PATH/$position"
@import "$COMMON_FILES_PATH/shape_$shape.rasi"
EOF

    ln -fs $COMMON_FILES_PATH/shape_$shape.cfg $USER_THEME_CONFIG.cfg

}

run_conf () {

    echo "$shape-$theme"
    naivecalendar -t "$CONFIG_NAME"

}


# Get theme components
position="position.rasi"

if ( "$IS_ALL" ); then

    themes=$(ls $COMMON_FILES_PATH/ | grep "^theme.*\.rasi" | sed 's/theme_\(.*\)\.rasi/\1/g') 
    shapes=$(ls $COMMON_FILES_PATH/ | grep "^shape.*\.rasi" | sed 's/shape_\(.*\)\.rasi/\1/g') 
    
    for shape in $shapes; do
        for theme in $themes; do
            gen_conf
            run_conf
        done
    done

else

    # Get shape and theme from user
    theme=$(
        echo -e $(ls $COMMON_FILES_PATH/ | grep "^theme.*\.rasi" | sed 's/theme_\(.*\)\.rasi/\1/g') |
        rofi -dmenu -sep " " -p "Choose a theme"
    )

    shape=$(
        echo -e $(ls $COMMON_FILES_PATH/ | grep "^shape.*\.rasi" | sed 's/shape_\(.*\)\.rasi/\1/g') |
        rofi -dmenu -sep " " -p "Choose a shape"
    )

    gen_conf
    run_conf

fi
